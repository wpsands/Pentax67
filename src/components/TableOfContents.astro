---
interface Props {
  sections: { id: string; label: string }[];
}

const { sections } = Astro.props;
---

<!-- Desktop sidebar -->
<aside id="toc-sidebar" class="hidden lg:block">
  <nav class="sticky top-20 w-56 shrink-0" aria-label="Table of contents">
    <p class="font-sans text-xs font-semibold uppercase tracking-wider text-warm mb-4">Contents</p>
    <ul class="space-y-1 text-sm font-sans border-l border-dark-700">
      {sections.map(({ id, label }) => (
        <li>
          <a
            href={`#${id}`}
            data-toc-link={id}
            class="block pl-4 py-1 text-slate-500 hover:text-warm border-l-2 border-transparent hover:border-warm transition-colors no-underline"
          >
            {label}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</aside>

<!-- Mobile panel -->
<div id="toc-mobile" class="hidden fixed inset-0 z-40 lg:hidden">
  <div id="toc-overlay" class="absolute inset-0 bg-dark-950/80 backdrop-blur-sm"></div>
  <nav class="absolute right-0 top-14 bottom-0 w-72 bg-dark-900 border-l border-dark-700 overflow-y-auto p-6" aria-label="Table of contents">
    <p class="font-sans text-xs font-semibold uppercase tracking-wider text-warm mb-4">Contents</p>
    <ul class="space-y-1 text-sm font-sans">
      {sections.map(({ id, label }) => (
        <li>
          <a
            href={`#${id}`}
            class="block py-2 text-slate-400 hover:text-warm transition-colors no-underline toc-mobile-link"
          >
            {label}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</div>

<script>
  const toggle = document.getElementById('toc-toggle');
  const mobile = document.getElementById('toc-mobile');
  const overlay = document.getElementById('toc-overlay');

  function closeMobile() {
    mobile?.classList.add('hidden');
  }

  toggle?.addEventListener('click', () => {
    mobile?.classList.toggle('hidden');
  });

  overlay?.addEventListener('click', closeMobile);

  document.querySelectorAll('.toc-mobile-link').forEach(link => {
    link.addEventListener('click', closeMobile);
  });

  // Intersection Observer for active section highlighting
  const tocLinks = document.querySelectorAll('[data-toc-link]');
  const sectionIds = Array.from(tocLinks).map(el => (el as HTMLElement).dataset.tocLink!);
  const sectionEls = sectionIds.map(id => document.getElementById(id)).filter(Boolean) as HTMLElement[];

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const link = document.querySelector(`[data-toc-link="${entry.target.id}"]`);
        if (!link) return;
        if (entry.isIntersecting) {
          tocLinks.forEach(l => {
            l.classList.remove('!text-warm', '!border-warm');
            l.classList.add('text-slate-500', 'border-transparent');
          });
          link.classList.add('!text-warm', '!border-warm');
          link.classList.remove('text-slate-500', 'border-transparent');
        }
      });
    },
    { rootMargin: '-80px 0px -70% 0px', threshold: 0 }
  );

  sectionEls.forEach(el => observer.observe(el));
</script>
